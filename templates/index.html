{% extends "base.html" %}

{% block title %}Photobooth{% endblock %}

{% block content %}
<div class="container-fluid p-3" style="height: 100vh; overflow: hidden; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #1a1a1a;">
    <style>
    /* Ajustements spécifiques pour les petits écrans 800x480 */
    @media (max-width: 800px) and (max-height: 480px) {
        #videoContainer {
            height: calc(100vh - 1rem);
            width: calc(100vw - 1rem);
        }

        #videoPreview {
            max-width: calc(100vw - 1rem);
            max-height: calc(100vh - 1rem);
        }

        #captureBtn {
            font-size: 1.2rem;
            padding: 8px 16px;
        }
    }

    .usb-photo-item {
        border-radius: 15px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease;
    }

    .usb-photo-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    .usb-photo-item.active {
        border: 3px solid #1e88e5;
        box-shadow: 0 8px 20px rgba(30, 136, 229, 0.35);
    }

    .usb-photo-item img {
        object-fit: cover;
        width: 100%;
        height: 100%;
    }
    </style>
    <!-- Conteneur vidéo avec marges élégantes -->
    <div class="video-container position-relative d-flex align-items-center justify-content-center" id="videoContainer" style="height: calc(100vh - 2rem); width: calc(100vw - 2rem);">
        <img id="videoPreview" 
             src="{{ url_for('video_stream') }}" 
             style="max-width: calc(100vw - 2rem); max-height: calc(100vh - 2rem); width: auto; height: auto; object-fit: contain; background-color: #000; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);"
             alt="Flux vidéo caméra">
        
        <!-- Countdown overlay -->
        <div class="countdown d-none position-absolute top-50 start-50 translate-middle" id="countdown"></div>
        
        <!-- Flash blanc pour la prise de photo -->
        <div class="flash-overlay d-none position-fixed top-0 start-0 w-100 h-100" id="flashOverlay" 
             style="background-color: white; z-index: 15; display: flex; align-items: center; justify-content: center;">
            <div style="font-size: 8rem; font-weight: bold; color: black; text-shadow: none;">CHEESE!</div>
        </div>
        
        <!-- Bouton capture en overlay -->
        <div class="position-absolute bottom-0 start-50 translate-middle-x mb-4" style="z-index: 5;">
            <div class="d-flex flex-column flex-md-row align-items-center gap-3">
                <button id="captureBtn" class="btn btn-danger btn-lg px-5 py-3" onclick="capturePhoto()"
                        style="font-size: 1.5rem; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                    <i class="fas fa-camera fa-2x"></i>
                </button>
                <button id="usbManagerBtn" class="btn btn-usb btn-lg px-4 py-3" onclick="openUsbManager()"
                        style="font-size: 1.1rem; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                    <i class="fas fa-usb me-2"></i>
                    Gérer USB
                </button>
            </div>
        </div>
    </div>
    
    <!-- Alerte manque de papier -->
    <div class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 20; width: 90%; max-width: 500px;">
        <div class="alert alert-warning d-none d-flex align-items-center" id="paper-alert" style="border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div>
                <strong>Attention !</strong><br>
                <small>Vérifiez le papier de l'imprimante avant de prendre une photo</small>
            </div>
        </div>
    </div>
</div>

<!-- Modale de gestion USB -->
<div class="modal fade" id="usbManagerModal" tabindex="-1" aria-labelledby="usbManagerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(45deg, #1e88e5, #1565c0); color: #fff;">
                <h5 class="modal-title" id="usbManagerModalLabel">
                    <i class="fas fa-usb me-2"></i>
                    Gestion des photos USB
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div id="usbManagerAlert" class="alert alert-warning d-none" role="alert">
                    Aucune clé USB détectée. Branchez une clé et cliquez sur Rafraîchir.
                </div>
                <div id="usbManagerContent">
                    <div class="row g-4">
                        <div class="col-lg-7">
                            <div id="usbPhotosContainer" class="row g-3"></div>
                        </div>
                        <div class="col-lg-5">
                            <div class="card bg-dark text-white h-100 shadow-sm">
                                <div class="card-body d-flex flex-column justify-content-center" id="usbPhotoPreview">
                                    <p class="text-muted text-center mb-0">Sélectionnez une photo pour l'aperçu.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div>
                    <small class="text-muted" id="usbMountInfo"></small>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-usb" id="usbRefreshBtn">
                        <i class="fas fa-sync-alt me-2"></i>
                        Rafraîchir
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overlay diaporama -->
<div id="slideshowOverlay" class="d-none" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div class="slideshow-container" style="width: 100%; height: 100%; position: relative;">
        <img id="slideshowImage" 
             style="width: 100%; height: 100%; object-fit: contain;" 
             alt="Photo du diaporama">
        
        <!-- Indicateur de progression -->
        <div class="slideshow-info position-absolute bottom-0 start-0 end-0 p-4 text-white" style="background: linear-gradient(transparent, rgba(0,0,0,0.7));">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1" id="slideshowTitle">Diaporama</h5>
                    <small id="slideshowCounter">Photo 1 sur 10</small>
                </div>
                <div class="text-end">
                    <small class="text-muted">Appuyez sur l'écran pour revenir</small>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isCapturing = false;
let usbManagerModal = null;
let usbPhotos = [];
let selectedUsbPhotoName = null;

// Initialiser la caméra au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    initCamera();
    const refreshBtn = document.getElementById('usbRefreshBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => refreshUsbPhotos());
    }
    const modalEl = document.getElementById('usbManagerModal');
    if (modalEl) {
        modalEl.addEventListener('hidden.bs.modal', () => {
            selectedUsbPhotoName = null;
            updateUsbPreview(null);
            highlightSelectedUsb(null);
        });
    }
});

function initCamera() {
    try {
        console.log('Initialisation du flux vidéo caméra...');
        
        const videoPreview = document.getElementById('videoPreview');
        
        // Gérer les erreurs de chargement du flux
        videoPreview.onerror = function() {
            console.error('Erreur de chargement du flux vidéo');
            showCameraError();
        };
        
        // Gérer le chargement réussi
        videoPreview.onload = function() {
            console.log('Flux vidéo caméra démarré avec succès');
        };
        
        // Démarrer le flux via l'API
        fetch('/start_camera')
            .then(response => response.json())
            .then(data => {
                console.log('Caméra initialisée:', data.status);
            })
            .catch(error => {
                console.error('Erreur d\'initialisation caméra:', error);
            });
        
    } catch (error) {
        console.error('Erreur d\'accès à la caméra:', error);
        showCameraError();
    }
}

function showCameraError() {
    document.getElementById('videoContainer').innerHTML = 
        '<div class="alert alert-warning m-3">' +
        '<i class="fas fa-exclamation-triangle me-2"></i>' +
        'Impossible d\'accéder à la caméra. Vérifiez que libcamera est installé et que la caméra est connectée.' +
        '</div>';
}

function capturePhoto() {
    if (isCapturing) return;
    
    isCapturing = true;
    const captureBtn = document.getElementById('captureBtn');
    const countdown = document.getElementById('countdown');
    
    // Désactiver le bouton
    captureBtn.disabled = true;
    captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin fa-2x"></i>';
    
    // Démarrer le compte à rebours
    let timeLeft = parseInt('{{ timer }}');
    countdown.classList.remove('d-none');
    
    const countdownInterval = setInterval(() => {
        countdown.textContent = timeLeft;
        timeLeft--;
        
        if (timeLeft < 0) {
            clearInterval(countdownInterval);
            countdown.textContent = 'CHEESE!';
            
            // Déclencher le flash blanc
            setTimeout(() => {
                countdown.classList.add('d-none');
                const flashOverlay = document.getElementById('flashOverlay');
                flashOverlay.classList.remove('d-none');
                
                // Masquer le flash après un court délai et prendre la photo
                setTimeout(() => {
                    flashOverlay.classList.add('d-none');
                    takePicture();
                }, 300);
            }, 200);
        }
    }, 1000);
}

async function takePicture() {
    try {
        const response = await fetch('/capture', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Rediriger vers la page de révision
            window.location.href = '/review';
        } else {
            throw new Error(result.error || 'Erreur de capture');
        }
        
    } catch (error) {
        console.error('Erreur lors de la capture:', error);
        alert('Erreur lors de la prise de photo: ' + error.message);
        
        resetCaptureButton();
    }
}

function openUsbManager() {
    if (!usbManagerModal) {
        const modalElement = document.getElementById('usbManagerModal');
        usbManagerModal = new bootstrap.Modal(modalElement);
    }
    refreshUsbPhotos();
    usbManagerModal.show();
}

async function refreshUsbPhotos(showToastOnError = false) {
    const container = document.getElementById('usbPhotosContainer');
    const alertBox = document.getElementById('usbManagerAlert');
    const mountInfo = document.getElementById('usbMountInfo');

    if (container) {
        container.innerHTML = `
            <div class="col-12 text-center text-muted py-5">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <div>Chargement des photos...</div>
            </div>
        `;
    }
    if (alertBox) {
        alertBox.classList.add('d-none');
    }
    if (mountInfo) {
        mountInfo.textContent = '';
    }

    try {
        const response = await fetch('/usb/photos');
        const result = await response.json();
        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Erreur lors du chargement de la clé USB');
        }

        usbPhotos = result.photos || [];
        if (mountInfo && result.mount_point) {
            mountInfo.textContent = `Montage : ${result.mount_point}`;
        }

        renderUsbPhotos();
        if (!usbPhotos.length && container) {
            container.innerHTML = `
                <div class="col-12 text-center text-muted py-5">
                    Aucune photo dans le dossier SimpleBooth.
                </div>
            `;
            updateUsbPreview(null);
        }
    } catch (error) {
        console.error('Erreur lors du chargement USB:', error);
        if (alertBox) {
            const message = error.message && !error.message.includes('Aucune clé USB détectée')
                ? error.message
                : 'Aucune clé USB détectée. Branchez une clé et cliquez sur Rafraîchir.';
            alertBox.textContent = message;
            alertBox.classList.remove('d-none');
            if (showToastOnError) {
                showToast(message, 'error');
            }
        }
        if (container) {
            container.innerHTML = '';
        }
        if (mountInfo) {
            mountInfo.textContent = '';
        }
        usbPhotos = [];
        selectedUsbPhotoName = null;
        updateUsbPreview(null);
        highlightSelectedUsb(null);
    }
}

function renderUsbPhotos() {
    const container = document.getElementById('usbPhotosContainer');
    if (!container) return;

    container.innerHTML = '';
    usbPhotos.forEach(photo => {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-xl-3';

        const card = document.createElement('div');
        card.className = 'usb-photo-item card h-100 border-0 shadow-sm';
        card.dataset.name = photo.name;

        card.innerHTML = `
            <div class="ratio ratio-4x3">
                <img src="${photo.url}" alt="${photo.name}" class="w-100 h-100">
            </div>
            <div class="card-body p-3">
                <div class="fw-bold text-truncate" title="${photo.name}">${photo.name}</div>
                <div class="small text-muted">${formatBytes(photo.size)}</div>
                <div class="small text-muted">${formatDate(photo.mtime)}</div>
            </div>
        `;

        card.addEventListener('click', () => {
            selectedUsbPhotoName = photo.name;
            highlightSelectedUsb(photo.name);
            updateUsbPreview(photo);
        });

        if (photo.name === selectedUsbPhotoName) {
            card.classList.add('active');
        }

        col.appendChild(card);
        container.appendChild(col);
    });

    if (selectedUsbPhotoName) {
        const selectedPhoto = usbPhotos.find(photo => photo.name === selectedUsbPhotoName);
        if (selectedPhoto) {
            updateUsbPreview(selectedPhoto);
            highlightSelectedUsb(selectedUsbPhotoName);
            return;
        }
    }

    updateUsbPreview(null);
}

function updateUsbPreview(photo) {
    const preview = document.getElementById('usbPhotoPreview');
    if (!preview) return;

    if (!photo) {
        preview.innerHTML = '<p class="text-muted text-center mb-0">Sélectionnez une photo pour l\'aperçu.</p>';
        return;
    }

    preview.innerHTML = `
        <div class="w-100 mb-3 text-center">
            <img src="${photo.url}" alt="${photo.name}" class="img-fluid rounded shadow" style="max-height: 320px; object-fit: contain;">
        </div>
        <div class="w-100">
            <h5 class="mb-2">${photo.name}</h5>
            <p class="mb-1"><strong>Taille :</strong> ${formatBytes(photo.size)}</p>
            <p class="mb-3"><strong>Date :</strong> ${formatDate(photo.mtime)}</p>
            <div class="d-flex flex-column flex-sm-row gap-2">
                <button type="button" class="btn btn-danger flex-grow-1" id="usbDeleteBtn">
                    <i class="fas fa-trash me-2"></i>Supprimer
                </button>
                <button type="button" class="btn btn-outline-light flex-grow-1" id="usbKeepBtn">
                    <i class="fas fa-check me-2"></i>Conserver
                </button>
            </div>
        </div>
    `;

    const deleteBtn = document.getElementById('usbDeleteBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', () => confirmDeleteUsbPhoto(photo.name));
    }

    const keepBtn = document.getElementById('usbKeepBtn');
    if (keepBtn) {
        keepBtn.addEventListener('click', closeUsbPreview);
    }
}

function highlightSelectedUsb(name) {
    document.querySelectorAll('#usbPhotosContainer .usb-photo-item').forEach(item => {
        item.classList.toggle('active', !!name && item.dataset.name === name);
    });
}

function closeUsbPreview() {
    selectedUsbPhotoName = null;
    updateUsbPreview(null);
    highlightSelectedUsb(null);
}

async function confirmDeleteUsbPhoto(name) {
    if (!confirm('Êtes-vous sûr ?')) {
        return;
    }
    try {
        const response = await fetch(`/usb/photo/${encodeURIComponent(name)}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Erreur lors de la suppression');
        }
        showToast('Photo supprimée de la clé USB.', 'success');
        selectedUsbPhotoName = null;
        await refreshUsbPhotos(true);
    } catch (error) {
        console.error('Erreur lors de la suppression USB:', error);
        showToast(error.message || 'Erreur lors de la suppression', 'error');
    }
}

function formatBytes(bytes) {
    if (!Number.isFinite(bytes)) {
        return '-';
    }
    const units = ['o', 'Ko', 'Mo', 'Go'];
    let index = 0;
    let value = bytes;
    while (value >= 1024 && index < units.length - 1) {
        value /= 1024;
        index += 1;
    }
    return `${value.toFixed(value < 10 && index > 0 ? 1 : 0)} ${units[index]}`;
}

function formatDate(timestamp) {
    try {
        return new Date(timestamp * 1000).toLocaleString('fr-FR');
    } catch (error) {
        return '-';
    }
}

function resetCaptureButton() {
    isCapturing = false;
    const captureBtn = document.getElementById('captureBtn');
    captureBtn.disabled = false;
    captureBtn.innerHTML = '<i class="fas fa-camera fa-2x"></i>';
}

// Variables pour le diaporama
let slideshowConfig = null;
let slideshowPhotos = [];
let slideshowActive = false;
let slideshowIndex = 0;
let slideshowInterval = null;

let inactivityTimer = null;
let lastActivity = Date.now();

// Initialiser le diaporama au chargement
document.addEventListener('DOMContentLoaded', function() {
    loadSlideshowConfig();
    setupActivityTracking();
});

async function loadSlideshowConfig() {
    try {
        const response = await fetch('/api/slideshow');
        slideshowConfig = await response.json();
        
        if (slideshowConfig.enabled && slideshowConfig.photos.length > 0) {
            slideshowPhotos = slideshowConfig.photos;
            startInactivityTimer();
        }
    } catch (error) {
        console.error('Erreur chargement config diaporama:', error);
    }
}

function setupActivityTracking() {
    // Détecter l'activité utilisateur
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
        document.addEventListener(event, resetInactivityTimer, true);
    });
}

function resetInactivityTimer() {
    lastActivity = Date.now();
    
    if (slideshowActive) {
        // Si le diaporama est actif, le fermer
        stopSlideshow();
        return;
    }
    
    // Redémarrer le timer d'inactivité
    if (inactivityTimer) {
        clearTimeout(inactivityTimer);
    }
    
    if (slideshowConfig && slideshowConfig.enabled && slideshowPhotos.length > 0) {
        startInactivityTimer();
    }
}

function startInactivityTimer() {
    if (inactivityTimer) {
        clearTimeout(inactivityTimer);
    }
    
    inactivityTimer = setTimeout(() => {
        if (!slideshowActive && slideshowPhotos.length > 0) {
            startSlideshow();
        }
    }, slideshowConfig.delay * 1000);
}

function startSlideshow() {
    if (slideshowPhotos.length === 0) return;
    
    slideshowActive = true;
    slideshowIndex = 0;
    
    const overlay = document.getElementById('slideshowOverlay');
    overlay.classList.remove('d-none');
    overlay.style.display = 'flex';
    
    // Ajouter l'événement de clic pour fermer
    overlay.addEventListener('click', stopSlideshow);
    
    showCurrentSlide();
    
    // Démarrer la rotation automatique (5 secondes par photo)
    slideshowInterval = setInterval(() => {
        nextSlide();
    }, 5000);
    

}

function stopSlideshow() {
    slideshowActive = false;
    
    const overlay = document.getElementById('slideshowOverlay');
    overlay.classList.add('d-none');
    overlay.style.display = 'none';
    
    // Nettoyer les intervals
    if (slideshowInterval) {
        clearInterval(slideshowInterval);
        slideshowInterval = null;
    }
    

    
    // Redémarrer le timer d'inactivité
    startInactivityTimer();
}

function showCurrentSlide() {
    if (slideshowPhotos.length === 0) return;
    
    const image = document.getElementById('slideshowImage');
    const counter = document.getElementById('slideshowCounter');
    
    image.src = `/photos/${slideshowPhotos[slideshowIndex]}`;
    counter.textContent = `Photo ${slideshowIndex + 1} sur ${slideshowPhotos.length}`;
    

}

function nextSlide() {
    slideshowIndex = (slideshowIndex + 1) % slideshowPhotos.length;
    showCurrentSlide();

}



// Vérifier le statut de l'imprimante pour l'alerte papier
function checkPrinterPaperStatus() {
    fetch('/api/printer_status')
        .then(response => response.json())
        .then(data => {
            const paperAlert = document.getElementById('paper-alert');
            
            // Afficher l'alerte seulement si l'imprimante est activée et qu'il y a un problème de papier
            if (data.status === 'ok' && data.paper_status && data.paper_status !== 'ok' && data.paper_status !== 'unknown') {
                paperAlert.classList.remove('d-none');
            } else {
                paperAlert.classList.add('d-none');
            }
        })
        .catch(error => {
            console.error('Erreur vérification papier:', error);
            // Masquer l'alerte en cas d'erreur
            document.getElementById('paper-alert').classList.add('d-none');
        });
}

// Vérifier le papier au chargement et périodiquement
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier si on doit forcer l'affichage de l'alerte papier
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('show_paper_alert') === '1') {
        // Forcer l'affichage de l'alerte
        const paperAlert = document.getElementById('paper-alert');
        paperAlert.classList.remove('d-none');
        
        // Nettoyer l'URL sans recharger la page
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    checkPrinterPaperStatus();
    // Vérifier toutes les 30 secondes
    setInterval(checkPrinterPaperStatus, 30000);
});

// Nettoyer les ressources lors de la fermeture
window.addEventListener('beforeunload', function() {
    fetch('/stop_camera').catch(error => {
        console.log('Erreur arrêt caméra:', error);
    });
});
</script>
{% endblock %}
